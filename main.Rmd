---
title: "corona"
author: "Jan Netík"
date: "16 3 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Balíky

```{r}
library(jsonlite)
library(tidyverse)
library(magrittr)
library(pander)
library(lubridate)
```

## Import dat

MZCR Google Data Studio - apify

```{r}
raw <-
  fromJSON(
    "https://api.apify.com/v2/key-value-stores/K373S4uCFR9W1K8ei/records/LATEST?disableRedirect=true"
  )
tibble(
infected = raw$infected,
recovered = raw$recovered,
tested = raw$numberOfTestedGraph$value %>% last) %>% pander

```

## kumulativní čenosti

Celkový počet testovaných se udává jednou denně, takže když poslední den chybí, tak se přidá NA:

```{r}
df_cum <- tibble(date = as.Date(raw$totalPositiveTests$date), positive = raw$totalPositiveTests$value)
tested = tibble(tested = raw$numberOfTestedGraph$value, date = as.Date(raw$numberOfTestedGraph$date))

df_cum <- left_join(df_cum, tested, by = "date") %>% mutate_if(is.character, parse_number)

```

kvůli snažší práci a fitování dataset začneme outbreakem

```{r}
df_cum %<>% filter(positive > 0)
```

## predikce

moc daleká predikce je výpočetně náročná!

```{r}
fit <- lm(log(positive) ~ date, data = df_cum)
cat("Adj. koef. determinace:", summary(fit)[["adj.r.squared"]])

dates_to_predict <-
  seq.Date(min(df_cum$date), as.Date("2020-03-31"), by = 1)

pred <- tibble(date = dates_to_predict, positive_pred = exp(predict(fit, list(date = dates_to_predict))))

df_cum %<>% right_join(pred, by = "date")
```
## Diag. lag

nejdřív vyrobíme case-by-case denní ppočty

nulu přidáváme aby první den měl skutečně rozdíl od nuly
+ zaokrouhlíme...

```{r}
df_pd <-
  tibble(positive_pred_pd = round(diff(c(
    0, df_cum$positive_pred
  ))), date = df_cum$date)

confirmation_date = rep(df_pd$date, df_pd$positive_pred_pd)

```

data z: [](https://www.kaggle.com/codelion/covid19-outbreak-epidemiological-line-list-data)

lagy jsou z ekvivalentního období - outbreaku v číně bez Hubei

```{r}
days_to_confirmation <-
  read_csv("onset_confirm_data.csv") %>% filter(country == "China") %>% filter(confirmation >= as.Date("2020-01-10") & confirmation <= as.Date("2020-01-10")+(now() %>% as.Date - as.Date("2020-03-01"))) %>% select(days_to_confirmation)

temp <- NULL
# for (i in 1:length(confirmation_date)) {
#   lag[i] <- sample(days_to_confirmation, 1)
# }

temp2 <- NULL

# pro každý řádek cum. pred positive vygenerovat lagy
for (i in 1:nrow(df_cum)) {
  lags <- sample_n(days_to_confirmation,
                  round(df_cum$positive_pred[i]), T) %>% pull
  est_onset_temp <- df_cum$date[i] - lags
  temp[[i]] <- tibble(dates = est_onset_temp, positive_pred = rep(df_cum$positive_pred[i], length(est_onset_temp)))
 temp2[[i]] <- quantile(est_onset_temp, probs = .5, type = 1)
 # dates_quantiles[[i]] <- quantile(est_onset_temp, probs = c(0.25, 0.5, 0.975), type = 1)
}

df_cum$est_onset_mean <- temp2 %>% as_date

df_cum %>% write_csv("table.csv")

df_cum %>% ggplot(aes(date, positive_pred)) +
  geom_line() +
  geom_line(aes(est_onset_mean, positive_pred), col="red") +
  # coord_cartesian(ylim= c(0,40000)) +
  theme_minimal()

# dates_quantiles %>% bind_rows()

onsets_for_positives <- bind_rows(temp)

# cbc <- tibble(confirmed = confirmation_date, lag) %>%
#   mutate(est_onset = confirmed - lag)

# est_onset_date_range <- seq(min(cbc$est_onset), max(cbc$est_onset), by="days")

# cbc %<>% count(est_onset) %>% complete(data.frame(est_onset = est_onset_date_range), fill = list(n = 0)) %>% mutate(n_cum = cumsum(n))

df_full <- left_join(df_cum, onsets_for_positives, by = "positive_pred")
```

```{r}
df_full %>% 
  ggplot(aes(date, positive_pred)) +
  geom_line() +
  geom_point(aes(dates, positive_pred)) +
  # coord_cartesian(ylim= c(0,40000)) +
  theme_minimal()
```

## graf

jelikož simulujeme zpětně onset u predikovaných případů, křivky se vždy nakonec protnou, je třeba simulovat dostatečně dopředu - týdny a pak lze osu y omezit

```{r eval=FALSE, include=FALSE}
df_full %>% select(-c(tested, positive)) %>%  pivot_longer(-date) %>%
  ggplot(aes(date, value, col = name)) +
  geom_line() +
  coord_cartesian(ylim= c(0,40000)) +
  theme_minimal()
```


## CSVcko

```{r eval=FALSE, include=FALSE}
df_full %>% transmute(date, tested, diagnosed_cases = positive, diagnosed_cases_prediction = positive_pred, true_cases) %>% write_csv("true_cases.csv")

```

10.1 v číně mimo Hubei je jako 1.3 u nás

takže brát data z číny od 10.1 do --počet dní--