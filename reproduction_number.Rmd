---
title: "Reproduction number daily"
author: "Jan Net√≠k"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r x, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
library(lubridate)
cat(paste0("#### Report generated: ", now()))
```
#### Data source: [https://onemocneni-aktualne.mzcr.cz/covid-19](https://onemocneni-aktualne.mzcr.cz/covid-19)

```{r, message=FALSE, warning=FALSE}
library(jsonlite)
library(tidyverse)
library(magrittr)
library(pander)
library(growthcurver)
library(distcrete)
library(lubridate)
remotes::install_github("reconhub/incidence")
library(incidence)
remotes::install_github("annecori/EpiEstim")
library(EpiEstim)

select <- dplyr::select
```



```{r}
raw <-
  fromJSON(
    "https://api.apify.com/v2/key-value-stores/K373S4uCFR9W1K8ei/records/LATEST?disableRedirect=true"
  )

tibble(
  infected = raw$infected,
  tested = raw$totalTested,
  recovered = raw$recovered
) %>% pander(caption = "Quick numbers")
```




```{r}
df_cum <-
  tibble(
    date = as.Date(raw$totalPositiveTests$date),
    positive = as.integer(raw$totalPositiveTests$value)
  ) %>% filter(positive > 0)

df_cum %>% pander(caption = "Cumulative number of positive cases")
```

For following analyses, we use *limited dataset* from outbreak beginning to last complete day (usually, *fully closed* data are given around 9 AM *the day after*).
<!-- Prepare incidence (day-to-day) data . -->
Please, **check the validity by hand**.

```{r}
df_cum %<>% filter(date + days(1) + hours(10) < now())

inc <- tibble(dates = df_cum$date, I = diff(c(0, df_cum$positive)))

tail(df_cum, 1) %>% pander(caption = "Last complete day used for all following analyses")
```

## Simple fitting

```{r}
mod_exp <- lm(log(positive) ~ date, data = df_cum)
mod_log <- SummarizeGrowth(seq(1, length(df_cum$date)), df_cum$positive)

days_of_prediction <- 7

date = seq.Date(
      first(df_cum$date),
      by = 1,
      length.out = length(df_cum$date) + days_of_prediction
    )

predicted <-
  tibble(
    date,
    logistic = predict(mod_log$model,
                           newdata = list(t = seq(
                             1, length(df_cum$date) + days_of_prediction
                           ))),
    exponential = exp(predict(mod_exp, newdata = list(date)))
  )

df_cum %<>% right_join(predicted, by = "date")

df_cum %>% pivot_longer(-c(date, positive)) %>% ggplot(aes(date, value, col = name)) + geom_line(size = 1.1) + geom_point(aes(date, positive), col = "black", na.rm = T, size = 1.5) + scale_x_date(date_breaks = "7 days", date_minor_breaks = "1 day", date_labels = "%Y-%m-%d") + labs(title = "Positive cases per day and simple projections for 7 days", y = "number of positive cases", col = "growth")
```


## Time-dependent reproduction number estimate $R_t$

### Probably best results is from model using log normal SI distribution (see below)

Based on 7-day sliding window and serial interval parameters from [https://doi.org/10.1101/2020.02.19.20025452](https://doi.org/10.1101/2020.02.19.20025452).

>Mean and standard deviation are 3.96 (95% CI 3.53-4.39) and 4.75 (95% CI 4.46-5.07) days, respectively, with 12.6% of reports indicating pre-symptomatic transmission.

Note that `EpiEstim` package does not allow to estimate $R_t$ with negative serial interval values, so following model relies on truncated normal approximation with mean 5.21 [4.47,5.95] and SD 3.66 [3.20,4.26]. Below, we provide lognorm and gamma distribution alternatives.

Here are the plots and table further detailing $R_t$ by each window (denoted with day-day range):

```{r}
dailyR <- estimate_R(inc, method = "parametric_si",
                  config = make_config(list(
                  mean_si = 2.02, std_si = 2.78)))

plot(dailyR, "all")
```


```{r}
dailyR$R %>% rename("window beginning" = t_start, "window ending" = t_end, "R mean" = "Mean(R)", "R standard deviation" =  "Std(R)", "2.5th percentile" = "Quantile.0.025(R)", "50th percentile" = "Median(R)", "97.5th percentile" = "Quantile.0.975(R)") %>% transmute(`window beginning`,`window ending`,`R mean`,`R standard deviation`,`2.5th percentile`,`50th percentile`,`97.5th percentile`) %>% set_rownames(paste0(.$`window beginning`, "--", .$`window ending`)) %>% select(-c(`window beginning`, `window ending`)) %>% pander(split.tables = Inf, split.cells = 1)
```

<!-- Let's compute discrete distribution from lognormal and gamma distributions (fitted on truncated (>0) data) from aforementioned article. Note that lognorm fit original distribution better (see AIC). -->

Here are the parameters for log normal and gamma distributions (fitted on truncated (>0) data) from aforementioned article. Note that log normal fit original distribution better (see AIC).

|Distribution | Mean/Shape [95% CI] | SD/Scale [95% CI] | AIC |
|:------|-------|--------|-------| --|
|Lognormal | 2.02 [1.76,2.31] |2.78 [2.39,3.25]|1,886.73|
|Gamma | 1.46 [1.38,1.54] |0.78 [0.72,0.84]| 1,898.63|


```{r}
# Lognormal (Shape, Scale) 2.02 [1.76,2.31] 2.78 [2.39,3.25] 
si_distr_lognorm <- distcrete("lnorm", interval = 1, 2.02, 2.78)$r(2000) %>% extract(.<20)

freq_lognorm <- table(si_distr_lognorm) %>% as.vector
si_distr_lognorm <- c(0, freq_lognorm/sum(freq_lognorm))

# Gamma (Shape, Scale) 1.46 [1.38,1.54] 0.78 [0.72,0.84]
si_distr_gamma <- distcrete("gamma", interval = 1, 1.46, 0.78)$r(2000) %>% extract(.<20)

freq_gamma <- table(si_distr_gamma) %>% as.vector
si_distr_gamma <- c(0, freq_gamma/sum(freq_gamma))
```

## Log normal

```{r}
dailyR_lognorm <- estimate_R(inc, 
                  method = "non_parametric_si",
                  config = make_config(list(
                      si_distr = si_distr_lognorm)))

plot(dailyR_lognorm, "all")
```


```{r}
dailyR_lognorm$R %>% rename("window beginning" = t_start, "window ending" = t_end, "R mean" = "Mean(R)", "R standard deviation" =  "Std(R)", "2.5th percentile" = "Quantile.0.025(R)", "50th percentile" = "Median(R)", "97.5th percentile" = "Quantile.0.975(R)") %>% transmute(`window beginning`,`window ending`,`R mean`,`R standard deviation`,`2.5th percentile`,`50th percentile`,`97.5th percentile`) %>% set_rownames(paste0(.$`window beginning`, "--", .$`window ending`)) %>% select(-c(`window beginning`, `window ending`)) %>% pander(split.tables = Inf, split.cells = 1)
```
## Gamma

```{r}
dailyR_gamma <- estimate_R(inc, 
                  method = "non_parametric_si",
                  config = make_config(list(
                      si_distr = si_distr_gamma)))

plot(dailyR_gamma, "all")
```


```{r}
dailyR_gamma$R %>% rename("window beginning" = t_start, "window ending" = t_end, "R mean" = "Mean(R)", "R standard deviation" =  "Std(R)", "2.5th percentile" = "Quantile.0.025(R)", "50th percentile" = "Median(R)", "97.5th percentile" = "Quantile.0.975(R)") %>% transmute(`window beginning`,`window ending`,`R mean`,`R standard deviation`,`2.5th percentile`,`50th percentile`,`97.5th percentile`) %>% set_rownames(paste0(.$`window beginning`, "--", .$`window ending`)) %>% select(-c(`window beginning`, `window ending`)) %>% pander(split.tables = Inf, split.cells = 1)
```
